<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Webhook URLs</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script>
    document.addEventListener('DOMContentLoaded', function(){
      // Render full origin URLs for display only
      const origin = window.location.origin.replace(/\/$/, '');
      document.querySelectorAll('[data-href-rel]').forEach(el => {
        const rel = el.getAttribute('data-href-rel');
        el.textContent = origin + '/' + rel.replace(/^\//,'');
      });
      
      // Copy buttons
      document.querySelectorAll('[data-copy]').forEach(btn => {
        btn.addEventListener('click', function(){
          const target = document.getElementById(btn.getAttribute('data-copy'));
          if (target) {
            navigator.clipboard.writeText(target.textContent || '').then(()=>{
              showToast('Copied URL to clipboard');
            });
          }
        })
      });

      // Show custom content-type when 'Other' selected
      const ctype = document.getElementById('ctype');
      const custom = document.getElementById('custom_ct');
      if (ctype && custom) {
        ctype.addEventListener('change', function(){
          if (ctype.value === 'other') { 
            custom.classList.remove('hidden'); 
          } else { 
            custom.classList.add('hidden'); 
          }
        });
      }

      // Delete webhook handler
      document.querySelectorAll('[data-delete-webhook]').forEach(btn => {
        btn.addEventListener('click', async function(e) {
          e.preventDefault();
          const webhookId = btn.getAttribute('data-delete-webhook');
          if (confirm('Delete this URL and its logs?')) {
            try {
              const response = await fetch(`/webhooks/${webhookId}`, {
                method: 'DELETE',
                headers: {
                  'Content-Type': 'application/json'
                }
              });
              if (response.ok) {
                location.reload();
              } else {
                showToast('Error deleting webhook');
              }
            } catch (error) {
              showToast('Error deleting webhook');
            }
          }
        });
      });
    });
    
    function showToast(msg){
      const t = document.createElement('div');
      t.className = 'fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-4 py-2 rounded-lg shadow-lg animate-[fadein_.2s_ease-out]';
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(()=>{ t.classList.add('opacity-0','transition','duration-300'); }, 1200);
      setTimeout(()=>{ t.remove(); }, 1600);
    }
  </script>
  <style>
    @keyframes fadein{ from{ opacity:0; transform:translate(-50%, 8px);} to{ opacity:1; transform:translate(-50%,0);} }
  </style>
</head>
<body>
  <div class="min-h-screen bg-gray-50 text-slate-900">
    <div class="max-w-5xl mx-auto px-4 py-10">
      <div class="bg-white border border-gray-200 rounded-2xl p-6 shadow-sm">
        <div class="flex items-center justify-between">
          <div>
            <h1 class="text-2xl font-semibold tracking-tight flex items-center gap-2">
              <i class="fa-solid fa-link text-emerald-600"></i>
              Webhook URLs
            </h1>
            <p class="text-slate-600 mt-1">Manage endpoints and choose response status. View captured requests.</p>
          </div>
          <form method="post" action="/webhooks" class="flex items-center gap-3">
            <label class="text-sm text-slate-600">Status</label>
            <select name="status" class="bg-white border border-gray-300 rounded-lg px-2 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500">
              <% statusChoices.forEach(choice => { %>
                <option value="<%= choice %>"><%= choice %></option>
              <% }); %>
            </select>
            <label class="text-sm text-slate-600">Type</label>
            <select id="ctype" name="content_type" class="bg-white border border-gray-300 rounded-lg px-2 py-2 text-sm focus:outline-none">
              <option value="html">HTML</option>
              <option value="json">JSON</option>
              <option value="text">Plain</option>
              <option value="xml">XML</option>
              <option value="other">Other</option>
            </select>
            <label class="text-sm text-slate-600">Forward to</label>
            <input name="destination" type="url" placeholder="https://example.com/receive" class="bg-white border border-gray-300 rounded-lg px-2 py-2 text-sm" />
            <input id="custom_ct" name="custom_content_type" type="text" placeholder="e.g. application/problem+json" class="hidden bg-white border border-gray-300 rounded-lg px-2 py-2 text-sm" />
            <button type="submit" class="inline-flex items-center gap-2 bg-emerald-600 hover:bg-emerald-500 text-white font-semibold px-4 py-2 rounded-lg shadow-sm transition">
              <i class="fa-solid fa-plus"></i>
              Add URL
            </button>
          </form>
        </div>

        <div class="mt-6 overflow-hidden rounded-xl border border-gray-200">
          <table class="w-full text-left">
            <thead class="bg-gray-50 text-slate-600 text-sm">
              <tr>
                <th class="px-4 py-3 font-semibold">URL</th>
                <th class="px-4 py-3 font-semibold w-24">Status</th>
                <th class="px-4 py-3 font-semibold w-28">Requests</th>
                <th class="px-4 py-3 font-semibold w-40">Content-Type</th>
                <th class="px-4 py-3 font-semibold w-64">Forward To</th>
                <th class="px-4 py-3 font-semibold w-64">Actions</th>
              </tr>
            </thead>
            <tbody class="divide-y divide-gray-100 bg-white">
              <% if (webhooks.length === 0) { %>
                <tr>
                  <td colspan="6" class="px-4 py-8 text-slate-600">No URLs yet. Create one above.</td>
                </tr>
              <% } else { %>
                <% webhooks.forEach(webhook => { %>
                  <tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-3 align-top">
                      <div class="font-mono text-sky-700 break-all flex items-center gap-2 min-w-max">
                        <i class="fa-solid fa-link"></i>
                        <a href="/request/<%= encodeURIComponent(webhook.id) %>" class="hover:underline" title="View requests">
                          <span id="u-<%= webhook.id %>" data-href-rel="webhook/<%= encodeURIComponent(webhook.id) %>">webhook/<%= webhook.id %></span>
                        </a>
                        <button type="button" class="ml-1 text-slate-500 hover:text-slate-700" data-copy="u-<%= webhook.id %>" title="Copy full URL">
                          <i class="fa-regular fa-copy"></i>
                        </button>
                      </div>
                      <div class="text-slate-600 text-xs mt-1">ID: <code class="font-mono"><%= webhook.id %></code> · Label: <%= webhook.label %></div>
                    </td>
                    <td class="px-4 py-3 align-top">
                      <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md border border-gray-300 bg-gray-50 text-slate-700 text-sm">
                        <i class="fa-solid fa-signal"></i>
                        <%= webhook.status %>
                      </span>
                    </td>
                    <td class="px-4 py-3 align-top font-mono text-slate-900"><%= webhook.request_count %></td>
                    <td class="px-4 py-3 align-top font-mono text-slate-900"><%= webhook.content_type %></td>
                    <td class="px-4 py-3 align-top font-mono text-sky-700 break-all">
                      <% if (webhook.destination) { %>
                        <a href="<%= webhook.destination %>" target="_blank" rel="noopener noreferrer" class="hover:underline text-xs truncate block"><%= webhook.destination %></a>
                      <% } else { %>
                        <span class="text-slate-500 text-xs">—</span>
                      <% } %>
                    </td>
                    <td class="px-4 py-3 align-top">
                      <div class="flex items-center gap-2">
                        <button data-delete-webhook="<%= webhook.id %>" class="inline-flex items-center gap-2 bg-rose-600 hover:bg-rose-500 text-white font-semibold px-3 py-2 rounded-lg shadow-sm transition" type="button">
                          <i class="fa-regular fa-trash-can"></i>
                          Delete
                        </button>
                      </div>
                    </td>
                  </tr>
                <% }); %>
              <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</body>
</html>